#!/bin/bash

# 1) Determine xrandr version
IFS="."
XRANDR_VERSION=( $(pkg-config --modversion xrandr) )
if ! [ $? -eq 0 ]; then
	exit 1
fi
echo "XRandR version is ${XRANDR_VERSION[*]}"
unset IFS

# For convenience: Check if Xlib headers are present
pkg-config --exists x11 || exit 1

# 2) Determine path to real xrandr library
REAL_LIBRARY=$(ldd `which xrandr` | sed -nre 's/.+libXrandr.so.+=> ([^ ]+).*/\1/p')
echo "The path to the real XRandR library is ${REAL_LIBRARY}"
if echo "${REAL_LIBRARY}" | grep -q local; then
	echo -e "\033[31mWARNING: \033[0m This looks as if you already have fakexrandr installed?!"
	REAL_LIBRARY=$(find /usr/lib -name libXrandr.so | head -n 1)
	if [ -z ${REAL_LIBRARY} ]; then
		echo "          Aborting: No other candidate was found in /usr/lib"
		exit 1
	fi
	echo "          Using ${REAL_LIBRARY} instead. (Found using \`file')"
fi
REAL_LIBRARY_DIR=$(dirname "${REAL_LIBRARY}")

# 3) Determine location for fake xrandr library
LIBRARY_DIRECTORIES=($(ldconfig -v 2>/dev/null | grep -oE '^/[^:]+'))
FAKE_LIBRARY_DIRECTORY=
CANDIDATES=
for DIR in ${LIBRARY_DIRECTORIES[@]}; do
	if [ "$DIR" == "${REAL_LIBRARY_DIR}" ]; then
		break
	fi
	CANDIDATES+="$DIR, "
	if echo $DIR | grep -q local; then
		FAKE_LIBRARY_DIRECTORY=$DIR
		break
	fi
done
if [ -z "${FAKE_LIBRARY_DIRECTORY}" ]; then
	echo
	echo -e "\033[31mERROR:\033[0m Failed to find a suitable directory for the fakeXrandr library"
	echo
	echo "You must place the library into the library search path, in a directory preceeding"
	echo "${REAL_LIBRARY_DIR}. In your system, this leaves the following candidates:"
	echo $CANDIDATES
	echo "None of these contains \`local', therefore I won't autoconfigure the installation to one"
	echo "of these directories. Either add a high-priority directory in /usr/local using the ldconfig"
	echo "mechanism (See /etc/ld.so.conf.d/ on most systems) or manually create config.h."
	echo
	exit 1
fi
echo "The fake library will be installed to ${FAKE_LIBRARY_DIRECTORY}"

XCB_LINE=
if pkg-config --exists xcb-randr; then
	echo "xcb-randr is available; also building xcb interface"

	REAL_XCB_RANDR_LIBRARY=$(find /usr/lib -name libxcb-randr.so | head -n 1)
	if [ -z ${REAL_XCB_RANDR_LIBRARY} ]; then
		echo "          Aborting: Did not find libxcb-randr.so in /usr/lib"
		exit 1
	fi
	echo "The path to the real libxcb-randr library is ${REAL_XCB_RANDR_LIBRARY}"
	XCB_LINE="#define REAL_XCB_RANDR_LIB \"${REAL_XCB_RANDR_LIBRARY}\""
fi

cat > config.h <<EOF
/* This file was automatically generated by ./configure */

#define XRANDR_MAJOR ${XRANDR_VERSION[0]}
#define XRANDR_MINOR ${XRANDR_VERSION[1]}
#define XRANDR_PATCH ${XRANDR_VERSION[2]}

#define REAL_XRANDR_LIB "${REAL_LIBRARY}"
#define FAKEXRANDR_INSTALL_DIR "${FAKE_LIBRARY_DIRECTORY}"
${XCB_LINE}
EOF

exit 0
